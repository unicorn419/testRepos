<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    
    <script>
        function upload(files) {
  
        }

        $(document).ready(function () {
            //$("#xPath").hide();
            $.get("api/ClientInfoes", function (data, status) {
                for (let c of data) {
                    $("#ClientInfo").append(new Option(c.clientAliasName, c.clientInfoId));
                }
            });

  

            $("#upload").click(function (files) {
                if (files.length === 0)
                    return;

                const formData = new FormData();

                for (let file of files)
                    formData.append(file.name, file);

                const uploadReq = new HttpRequest('POST', 'api/upload', formData, {
                    reportProgress: true,
                });

                this.http.request(uploadReq).subscribe(event => {
                    if (event.type === HttpEventType.UploadProgress)
                        this.progress = Math.round(100 * event.loaded / event.total);
                    else if (event.type === HttpEventType.Response) {
                        this.message = event.body.toString();
                    }
                    //this.message = JSON.parse(event.body.toString());
                });
            
            });

            $("#LoadTemplete").click(function () {
                urlPath = 'api/Templete?clientId=' + $("#ClientInfo  option:selected").val() + '&fileExtension=' + $("#fileType  option:selected").val();
                $.get(urlPath, function (data, status) {
                    GenerateHtml(data);
                });

            });

            $("#save").click(function () {
                alert($("#templete").text());


                $.post("api/Templete",
                    {
                        'clientId': $("#ClientInfo  option:selected").val(),
                        'fileExtension': $("#fileType  option:selected").val(),
                        'fileEncoding': $("#fileType  option:selected").val(),
                        'parserAssemble':'FileProcess.dll',
                        'parserClassName': $("#FileParser  option:selected").val(),
                        'parserConfig': $("#templete").text(),
                        'processAssemble': 'FileProcess.dll',
                        'processClassName': $("#FileProcess  option:selected").val()
                    },
                    function (data, status) {
                    });



            });

            

            $("#Analysis").click(function (fileName) {
                $("#xPath").find("option:selected").text("");
                $("#xPath").empty();
                var filename = "PPtoDH_20190812_190000.XIF";

                var urlPath = 'http://localhost:31553/DataElements/get?datafileName=' + filename;
                $.get(urlPath, function (data, status) {
                    var o = new Option("No Data", "");
                    $(o).html("");
                    $("#xPath").append(o);

                    for (var x of data) {
                        var o = new Option(x.xPath, x.name);
                        $(o).html(x.xPath);
                        $("#xPath").append(o);
                    }
                });

               

            });


        });

        function GenerateHtml(data)
        {

            var $tempDoc = $("#templete");
            $tempDoc.html('');
            $tempDoc.empty();
            $tempDoc.off('click');

            var idIndex = 0;
            var isInScript = false;
            var scriptText = '';
            for (let tmp of data) {
                var s = jQuery('<div />').text(tmp).html();
                if (s.indexOf("script&gt;") > 0) isInScript = !isInScript;
                if (isInScript) {
                    scriptText += s;
                    scriptText += '\r\n';
                    continue;
                }
                else if (scriptText !== '') {
                    scriptText += s;
                    idIndex++;
                    var textara = document.createElement('textarea');
                    textara.style.width = '100%';
                    textara.style.height = '100%';
                    //textara.nodeName = 'txtJavascript';
                    textara.innerHTML = scriptText;
                    textara.id = 'txtScript' + idIndex;
                    textara.rows = 8;
                    scriptText = '';
                    $tempDoc.append(textara);
                    var p = document.createElement('p');
                    $tempDoc.append(p);
                    continue;
                }

                //fixed item donot need select
                if (s.indexOf('name="ServiceTypeId"') > 0 ||
                    s.indexOf('name="DateInserted"') > 0 ||
                    s.indexOf('name="IsCurrentData"') > 0) {
                    $tempDoc.html($tempDoc.html() + s);
                    var p = document.createElement('p');
                    $tempDoc.append(p);
                    continue;
                }

                var i = s.indexOf('source="');
                if (i > 0) {
                    $tempDoc.html($tempDoc.html() + s.slice(0, i + 8));
                    s = s.slice(i + 8);
                    var link = document.createElement('button');
                    link.id = "source" + idIndex;
                    if (s.indexOf('"') === 0) {
                        link.innerText = '?';
                    }
                    else
                    {
                        link.innerText = s.slice(0, s.indexOf('"'));
                    }

                    $tempDoc.append(link);
                    s = s.slice(s.indexOf('"'));

                    $tempDoc.on('click', '#source' + idIndex, function () {
                        //var par = this.parentElement;
                        var $button = $(this);
                        var xpath = document.getElementById('xPath');
                        $button.after(xpath);
                        $('#xPath').one('change', function () {
                            $button.text($("#xPath option:selected").text());
                            //$button.val($("#xPath option:selected").text());
                            $('#Analysis').after($('#xPath'));
                        });

                    });
                }


                i = s.indexOf('default="');
                if (i > 0) {
                    $tempDoc.html($tempDoc.html() + s.slice(0, i + 9));
                    s = s.slice(i + 9);
                    text = s.substr(0, s.indexOf('"'));
                    s = s.slice(s.indexOf('"'));
                    var link = document.createElement('button');
                    link.id = "default" + idIndex;

                    if (text == '') link.innerText = '?';
                    else link.innerText = text;
                    $tempDoc.append(link);
                    $tempDoc.on('click', '#default' + idIndex, function () {
                        var $button = $(this);
                        var input = document.createElement("input");
                        input.id = 'defaultInput';

                        input.value = $button.text();
                        input.autofocus = true;
                        $button.after(input);
                        $button.attr('disabled', 'true');

                        $('#defaultInput').keyup(function (event) {
                            if (event.keyCode === 13) {
                                $button.text($("#defaultInput").val());
                                //$button.val($("#defaultInput").val());
                                this.remove();
                                $button.removeAttr('disabled');
                            }

                        });
                    });


                }

                i = s.indexOf('isNeedProcess="');
                if (i > 0) {
                    $tempDoc.html($tempDoc.html() + s.slice(0, i + 15));
                    s = s.slice(i + 15);
                    var text = s.substr(0, s.indexOf('"'));
                    s = s.slice(s.indexOf('"'));
                    var link = document.createElement('button');

                    link.className = 'isNeedProcess';
                    link.id = "isNeedProcess" + idIndex;

                    link.innerText = text;
                    $tempDoc.append(link);

                    $tempDoc.on('click', '#isNeedProcess' + idIndex, function () {
                        var $button = $(this);

                        var select = document.createElement("select");
                        select.id = "isNeedProcessSelect";

                        var opt = document.createElement("option");
                        opt.innerHTML = '';
                        opt.disabled = true;
                        opt.selected = true;
                        opt.value = '';
                        select.add(opt);

                        opt = document.createElement("option");
                        opt.innerText = "false";
                        opt.value = "false";
                        select.add(opt);
                        opt = document.createElement("option");

                        opt.innerText = "true";
                        opt.value = "true";
                        select.add(opt);

                        select.autofocus = true;
                        $button.after(select);
                        $button.attr('disabled', 'true');
                        $('#isNeedProcessSelect').change(function () {
                            $button.removeAttr('disabled');
                            var val = $("#isNeedProcessSelect option:selected").text();
                            //$button.text($("#isNeedProcessSelect option:selected").text());
                            //$button.val($("#isNeedProcessSelect option:selected").text());
                            $(this).remove();
                            if (val === $button.text()) return;
                            if (val === 'true') {
                                idIndex++;
                                var textara = document.createElement('textarea');
                                textara.style.width = '100%';
                                textara.style.height = '100%';
                                textara.id = 'txtScript' + idIndex;
                                textara.innerHTML = '<script>\r\n<\/script>';
                                textara.rows = 8;
                                //scriptText = 
                                $button.next().after(textara);
                            }
                            else {
                                var obj = $button.next().next();
                                obj.remove();
                                //obj.remove();
                                //$par.parentElement.nextSibling.remove();
                            }
                            $button.text(val);
                        });
                    });


                    idIndex++;
                }

                $tempDoc.html($tempDoc.html() + s);
                var p = document.createElement('p');
                $tempDoc.append(p);

            }

           
           


        }


       
    </script>
</head>
<body>
    <table>
        <tr>
            <td>
                <label>Step 1: Choose One Client:</label>
            </td>
            <td>
                <select name="ClientInfo" id="ClientInfo"></select>
            </td>
        </tr>
        <p></p>
        <tr>
            <td>
                <label>Step 2: Choose File Type and Encoding:</label>
            </td>

            <td>
                <select name="FileType" id="fileType">
                    <option value=".xif">XIF</option>
                    <option value=".xml">XML</option>
                    <option value=".txt">TXT</option>
                    <option value=".csv">CSV</option>
                </select>
                <select name="FileEncoding" id="FileEncoding">
                    <option value="ISO8859-1">ISO8859-1</option>
                    <option value="utf-8">utf-8</option>
                </select>
            </td>
        </tr>
        <p></p>
        <tr>
            <td>
                <label>Step 3: Choose One Parser :</label>
            </td>

            <td>
                <select name="FileParser" id="FileParser">
                    <option value="FileProcess.XIFFileParser">Common XML File Parser</option>
                </select>
                <p></p>
            </td>
        </tr>
        <p></p>
        <tr>
            <td>
                <label>Step 4: Choose One Processor :</label>
            </td>

            <td>
                <select name="FileProcess" id="FileProcess">
                    <option value="FileProcess.GBCFileProcessor">Common File Processor</option>
                </select>
                <p></p>
            </td>
        </tr>
        <p></p>
        <tr>
            <td>
                <label>Step 5: Choose one data file and upload to analysis:</label>
            </td>
            <td>
                <form method="post" enctype="multipart/form-data" action="api/Upload">
                    <input #file type="file" id="files" multiple />
                    <button id="upload">Upload</button>

                    <span style="font-weight:bold;color:green;" id="message">
                    </span>
                </form>    
            </td>
        </tr>
        <p></p>
        <tr>
            <td>
                <label>Step 6: Click button analysis:</label>
            </td>
            <td>
                <button id="Analysis">Analysis</button>
                <select id="xPath"></select>
                <p></p>
            </td>
        </tr>
        <tr>
            <td>
                <label>Step 7: Load Templete,then set:</label>
            </td>
            <td>
                <button id="LoadTemplete">Load</button>
                <p></p>
            </td>
        </tr>
    </table>
    <div id="templete">

    </div>

    <label>Step 8: Save :</label>

    <button id="save"> Save </button>






</body>
</html>